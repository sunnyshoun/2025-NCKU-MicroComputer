/*
 * main.c
 * WS2812 8x8 LED 控制程式（C 主程式）
 * 顯示數字 0-9，每秒切換，紅色亮度 50
 */

#include <xc.h>
#include <string.h>

// ===============================================
// 配置位元設定
// ===============================================
#pragma config OSC = HSPLL      // HS oscillator, PLL enabled (40MHz)
#pragma config WDT = OFF        // Watchdog Timer 關閉
#pragma config LVP = OFF        // Low Voltage Programming 關閉
#pragma config PBADEN = OFF     // PORTB<4:0> 設為數位 I/O
#pragma config DEBUG = OFF      // 除錯關閉
#pragma config MCLRE = ON       // MCLR 啟用

// ===============================================
// 常數定義
// ===============================================
#define NUM_LEDS 64
#define NUM_DIGITS 10

// ===============================================
// 外部函式宣告（來自 ws2812_driver.asm）
// ===============================================
extern void WS2812_Init(void);
extern void WS2812_SendBuffer(void);
extern void WS2812_Reset(void);

// ===============================================
// 全域變數
// ===============================================
unsigned char led_buffer[NUM_LEDS];     // LED 緩衝區 (0=黑, 非0=紅)

// ===============================================
// 數字圖案定義 (8x8 點陣)
// 每個數字 8 bytes，每個 byte 代表一行
// 位元 7 = 左邊，位元 0 = 右邊
// ===============================================
const unsigned char digit_patterns[NUM_DIGITS][8] = {
    // 數字 0
    {
        0b00111100,  // 行 0:   ****  
        0b01100110,  // 行 1:  **  ** 
        0b01100110,  // 行 2:  **  ** 
        0b01100110,  // 行 3:  **  ** 
        0b01100110,  // 行 4:  **  ** 
        0b01100110,  // 行 5:  **  ** 
        0b00111100,  // 行 6:   ****  
        0b00000000   // 行 7:         
    },
    
    // 數字 1
    {
        0b00011000,  // 行 0:    **   
        0b00111000,  // 行 1:   ***   
        0b00011000,  // 行 2:    **   
        0b00011000,  // 行 3:    **   
        0b00011000,  // 行 4:    **   
        0b00011000,  // 行 5:    **   
        0b01111110,  // 行 6:  ****** 
        0b00000000   // 行 7:         
    },
    
    // 數字 2
    {
        0b00111100,  // 行 0:   ****  
        0b01100110,  // 行 1:  **  ** 
        0b00000110,  // 行 2:      ** 
        0b00001100,  // 行 3:     **  
        0b00110000,  // 行 4:   **    
        0b01100000,  // 行 5:  **     
        0b01111110,  // 行 6:  ****** 
        0b00000000   // 行 7:         
    },
    
    // 數字 3
    {
        0b00111100,  // 行 0:   ****  
        0b01100110,  // 行 1:  **  ** 
        0b00000110,  // 行 2:      ** 
        0b00011100,  // 行 3:    ***  
        0b00000110,  // 行 4:      ** 
        0b01100110,  // 行 5:  **  ** 
        0b00111100,  // 行 6:   ****  
        0b00000000   // 行 7:         
    },
    
    // 數字 4
    {
        0b00001100,  // 行 0:     **  
        0b00011100,  // 行 1:    ***  
        0b00101100,  // 行 2:   * **  
        0b01001100,  // 行 3:  *  **  
        0b01111110,  // 行 4:  ****** 
        0b00001100,  // 行 5:     **  
        0b00001100,  // 行 6:     **  
        0b00000000   // 行 7:         
    },
    
    // 數字 5
    {
        0b01111110,  // 行 0:  ****** 
        0b01100000,  // 行 1:  **     
        0b01111100,  // 行 2:  *****  
        0b00000110,  // 行 3:      ** 
        0b00000110,  // 行 4:      ** 
        0b01100110,  // 行 5:  **  ** 
        0b00111100,  // 行 6:   ****  
        0b00000000   // 行 7:         
    },
    
    // 數字 6
    {
        0b00111100,  // 行 0:   ****  
        0b01100000,  // 行 1:  **     
        0b01111100,  // 行 2:  *****  
        0b01100110,  // 行 3:  **  ** 
        0b01100110,  // 行 4:  **  ** 
        0b01100110,  // 行 5:  **  ** 
        0b00111100,  // 行 6:   ****  
        0b00000000   // 行 7:         
    },
    
    // 數字 7
    {
        0b01111110,  // 行 0:  ****** 
        0b00000110,  // 行 1:      ** 
        0b00001100,  // 行 2:     **  
        0b00011000,  // 行 3:    **   
        0b00110000,  // 行 4:   **    
        0b00110000,  // 行 5:   **    
        0b00110000,  // 行 6:   **    
        0b00000000   // 行 7:         
    },
    
    // 數字 8
    {
        0b00111100,  // 行 0:   ****  
        0b01100110,  // 行 1:  **  ** 
        0b01100110,  // 行 2:  **  ** 
        0b00111100,  // 行 3:   ****  
        0b01100110,  // 行 4:  **  ** 
        0b01100110,  // 行 5:  **  ** 
        0b00111100,  // 行 6:   ****  
        0b00000000   // 行 7:         
    },
    
    // 數字 9
    {
        0b00111100,  // 行 0:   ****  
        0b01100110,  // 行 1:  **  ** 
        0b01100110,  // 行 2:  **  ** 
        0b00111110,  // 行 3:   ***** 
        0b00000110,  // 行 4:      ** 
        0b00001100,  // 行 5:     **  
        0b00111000,  // 行 6:   ***   
        0b00000000   // 行 7:         
    }
};

// ===============================================
// 函式宣告
// ===============================================
void ClearBuffer(void);
void DecodeDigitToBuffer(unsigned char digit);
void Delay_1s(void);

// ===============================================
// 主程式
// ===============================================
void main(void) {
    unsigned char current_digit = 0;
    
    // 初始化 WS2812
    WS2812_Init();
    
    // 主迴圈
    while(1) {
        // 顯示數字 0-9
        for(current_digit = 0; current_digit < NUM_DIGITS; current_digit++) {
            // 將數字解碼到緩衝區
            DecodeDigitToBuffer(current_digit);
            
            // 發送到 WS2812
            WS2812_SendBuffer();
            
            // 延遲 1 秒
            Delay_1s();
        }
    }
}

// ===============================================
// ClearBuffer - 清空 LED 緩衝區
// ===============================================
void ClearBuffer(void) {
    memset(led_buffer, 0, NUM_LEDS);
}

// ===============================================
// DecodeDigitToBuffer - 解碼數字到緩衝區
// 
// 輸入：digit = 0-9
// 輸出：led_buffer[64] 填入對應的圖案
// 
// 重要：使用列優先排列（Column-Major）
// LED 索引 = col * 8 + row
// ===============================================
void DecodeDigitToBuffer(unsigned char digit) {
    unsigned char row, col;
    unsigned char pattern_byte;
    unsigned char led_index;
    unsigned char bit_value;
    
    // 清空緩衝區
    ClearBuffer();
    
    // 處理 8 行圖案
    for(row = 0; row < 8; row++) {
        // 讀取當前行的圖案
        pattern_byte = digit_patterns[digit][row];
        
        // 處理 8 列（bit 7 到 bit 0）
        for(col = 0; col < 8; col++) {
            // 檢查位元值（從 bit 7 開始）
            bit_value = (pattern_byte >> (7 - col)) & 0x01;
            
            // 計算 LED 索引（列優先）
            led_index = col * 8 + row;
            
            // 存入緩衝區
            led_buffer[led_index] = bit_value;
        }
    }
}

// ===============================================
// Delay_1s - 延遲約 1 秒
// 
// 使用三層迴圈產生延遲
// 40MHz 時脈 = 10 MIPS (每條指令 0.4μs)
// ===============================================
void Delay_1s(void) {
    unsigned char i, j, k;
    
    // 三層迴圈：40 * 250 * 250 * 4μs ≈ 1 秒
    for(i = 0; i < 40; i++) {
        for(j = 0; j < 250; j++) {
            for(k = 0; k < 250; k++) {
                // 每次迴圈約 4μs
                __asm("nop");
                __asm("nop");
            }
        }
    }
}